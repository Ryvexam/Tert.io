{% extends 'base.html.twig' %}

{% block title %}Tertio Informatique - Contact{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .form-control { margin-bottom: 15px; }
        .invalid-feedback {
            display: none;
            color: red;
            font-size: 0.875em;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        #form-status {
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            display: none;
        }
        #form-status.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        #form-status.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .formbuilder-required {
            color: red;
            margin-left: 2px;
        }
    </style>
{% endblock %}

{% block content %}
    <main id="main">
        <div class="container initial-content-marge">
            <section id="contact" class="contact">
                <div class="container" data-aos="fade-up">
                    <header class="section-header">
                        <h2>Contactez-nous</h2>
                        <p>Laissez-nous vos coordonnées</p>
                    </header>

                    <div class="row justify-content-center mb-5">
                        <div class="col-lg-8">
                            <div class="php-email-form">
                                {{ form_start(form, {'attr': {'id': 'contact-form', 'class': 'rendered-form'}}) }}
                                <div class="row">
                                    <div class="col-md-6 formbuilder-text form-group">
                                        {{ form_label(form.nom, 'Nom', {'attr_label': {'class': 'formbuilder-text-label'}}) }}
                                        {{ form_widget(form.nom, {'attr': {'class': 'form-control', 'placeholder': 'Dupont', 'required': 'required', 'aria-required': 'true'}}) }}
                                        {{ form_errors(form.nom, {'attr': {'class': 'invalid-feedback'}}) }}
                                    </div>
                                    <div class="col-md-6 formbuilder-text form-group">
                                        {{ form_label(form.prenom, 'Prénom', {'attr_label': {'class': 'formbuilder-text-label'}}) }}
                                        {{ form_widget(form.prenom, {'attr': {'class': 'form-control', 'placeholder': 'Jean', 'required': 'required', 'aria-required': 'true'}}) }}
                                        {{ form_errors(form.prenom, {'attr': {'class': 'invalid-feedback'}}) }}
                                    </div>
                                    <div class="col-md-12 formbuilder-text form-group">
                                        {{ form_label(form.entreprise, 'Entreprise', {'attr_label': {'class': 'formbuilder-text-label'}}) }}
                                        {{ form_widget(form.entreprise, {'attr': {'class': 'form-control', 'placeholder': 'Google, Microsoft, etc...'}}) }}
                                        {{ form_errors(form.entreprise, {'attr': {'class': 'invalid-feedback'}}) }}
                                    </div>
                                    <div class="col-md-12 formbuilder-text form-group">
                                        {{ form_label(form.email, 'Email', {'attr_label': {'class': 'formbuilder-text-label'}}) }}
                                        {{ form_widget(form.email, {'attr': {'class': 'form-control', 'placeholder': 'jean@dupont.fr', 'required': 'required', 'aria-required': 'true', 'type': 'email'}}) }}
                                        {{ form_errors(form.email, {'attr': {'class': 'invalid-feedback'}}) }}
                                    </div>
                                    <div class="col-md-12 formbuilder-text form-group">
                                        {{ form_label(form.telephone, 'Téléphone', {'attr_label': {'class': 'formbuilder-text-label'}}) }}
                                        {{ form_widget(form.telephone, {'attr': {'class': 'form-control', 'placeholder': '0123456789', 'required': 'required', 'aria-required': 'true', 'type': 'tel'}}) }}
                                        {{ form_errors(form.telephone, {'attr': {'class': 'invalid-feedback'}}) }}
                                    </div>
                                    <div class="col-md-12 formbuilder-textarea form-group">
                                        {{ form_label(form.demande, 'Demande', {'attr_label': {'class': 'formbuilder-textarea-label'}}) }}
                                        {{ form_widget(form.demande, {'attr': {'class': 'form-control', 'placeholder': 'Ecrivez-ici votre demande', 'required': 'required', 'aria-required': 'true'}}) }}
                                        {{ form_errors(form.demande, {'attr': {'class': 'invalid-feedback'}}) }}
                                    </div>
                                    <div class="col-md-12 form-group">
                                        {{ form_widget(form.recaptcha) }}
                                        {{ form_errors(form.recaptcha, {'attr': {'class': 'invalid-feedback'}}) }}
                                    </div>
                                    <div class="col-md-12 text-center">
                                        <button type="submit" class="btn btn-primary">Envoyer</button>
                                    </div>
                                    {% if message is defined and message %}
                                        <div class="col-md-12 mt-3">
                                            <div class="alert {% if message.type == 'success' %}alert-success{% else %}alert-danger{% endif %}">
                                                <p>{{ message.message }}</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>

                                {{ form_end(form) }}
                                <div id="form-status" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[name="form"]');
            const formStatus = document.getElementById('form-status');

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);

                // Get the reCAPTCHA response
                const recaptchaResponse = grecaptcha.getResponse();
                formData.append('g-recaptcha-response', recaptchaResponse);

                fetch('/contact', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        formStatus.style.display = 'block';

                        if (data.status === 'success') {
                            formStatus.className = 'alert alert-success mt-3';
                            formStatus.textContent = data.message;
                            form.reset();
                            grecaptcha.reset();
                        } else {
                            formStatus.className = 'alert alert-danger mt-3';
                            formStatus.textContent = data.message;
                            if (data.errors) {
                                const errorList = document.createElement('ul');
                                data.errors.forEach(error => {
                                    const li = document.createElement('li');
                                    li.textContent = error;
                                    errorList.appendChild(li);
                                });
                                formStatus.appendChild(errorList);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        formStatus.style.display = 'block';
                        formStatus.className = 'alert alert-danger mt-3';
                        formStatus.textContent = 'Une erreur est survenue. Veuillez réessayer plus tard.';
                    });
            });
        });
    </script>
{% endblock %}